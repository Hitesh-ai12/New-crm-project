import"./bootstrap.min-DQoSNxk7.js";import{a as M}from"./axios-CdtiCRuU.js";import{_ as D,o as n,l as d,j as e,L as $,bo as j,F as x,Z as S,n as T,k as v,$ as L,bp as oe,P as q,aH as se,bq as he,r as w,w as P,f as Q,bi as ne,Y as te,h as ie,u as re,av as W,R as pe,p as ve,e as ae}from"./main-BxCp_q14.js";import{S as C}from"./sweetalert2.all-DyJFIm0t.js";import{E as de}from"./Editor-B7Lhi41L.js";import"./_commonjsHelpers-BosuxZz1.js";const fe={data(){return{leads:[],selectedLead:null,messages:[],searchQuery:""}},computed:{filteredLeads(){return this.leads.filter(o=>`${o.firstName||""} ${o.lastName||""}`.trim().toLowerCase().includes(this.searchQuery.toLowerCase()))}},methods:{async fetchLeads(){const s={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},p=await M.get("/api/email/chats",{headers:s});this.leads=p.data},async selectLead(o){const p={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},k=await M.get(`/api/email/lead/${o.leadId}`,{headers:p});this.selectedLead=o,this.messages=k.data.reverse(),this.$nextTick(()=>this.scrollToBottom())},scrollToBottom(){const o=this.$refs.emailArea;o&&(o.scrollTop=o.scrollHeight)}},mounted(){this.fetchLeads()}},ge={class:"email-chat d-flex shadow rounded",style:{"block-size":"90vh"}},be={class:"border-end p-3 col-lg-4 col-md-5 col-sm-5 col-xs-12 col-12",style:{"inline-size":"300px"}},ye={class:"header-search-area"},we=["onClick"],_e={class:"d-flex flex-column"},ke={class:"fw-bold"},xe={class:"d-flex justify-content-between align-items-center"},Ce={class:"badge bg-success"},Se={class:"text-muted"},Me={class:"flex-grow-1 d-flex flex-column bg-light"},$e={class:"border-bottom p-3 bg-white"},Le={key:0},Te={key:1,class:"text-muted"},Ee={class:"flex-grow-1 overflow-auto p-3",ref:"emailArea"},Ie={key:0,class:"text-center text-muted small"},Ae=["innerHTML"],je={class:"d-block text-end mt-1"};function Be(o,s,p,k,l,m){return n(),d("div",ge,[e("div",be,[e("div",ye,[$(e("input",{class:"form-control mb-2","onUpdate:modelValue":s[0]||(s[0]=t=>l.searchQuery=t),placeholder:"Enter Lead Name"},null,512),[[j,l.searchQuery]])]),(n(!0),d(x,null,S(m.filteredLeads,t=>{var b;return n(),d("div",{key:t.leadId,class:T(["lead-item p-2 border-bottom",{"bg-primary text-white":((b=l.selectedLead)==null?void 0:b.leadId)===t.leadId}]),onClick:y=>m.selectLead(t)},[e("div",_e,[e("div",ke,v(t.firstName)+" "+v(t.lastName),1),e("div",xe,[e("span",Ce,v(t.status||"Open"),1),e("small",Se,v(t.date||"16jun, 2025 | 11:00 am"),1)])])],10,we)}),128))]),e("div",Me,[e("div",$e,[l.selectedLead?(n(),d("h5",Le,v(l.selectedLead.firstName)+" "+v(l.selectedLead.lastName),1)):(n(),d("p",Te,"Select a lead to view emails"))]),e("div",Ee,[(n(!0),d(x,null,S(l.messages,(t,b)=>(n(),d("div",{key:b,class:"mb-3"},[t.date?(n(),d("div",Ie,v(t.date),1)):L("",!0),e("div",{class:T(["p-3 rounded shadow-sm",t.direction==="sent"?"bg-info text-white ms-auto":"bg-white me-auto"]),style:{"max-inline-size":"75%"}},[e("strong",null,v(t.subject),1),e("div",{class:"mt-1",innerHTML:t.description},null,8,Ae),e("small",je,v(t.time),1)],2)]))),128))],512)])])}const ze=D(fe,[["render",Be]]),Ne={data(){return{searchQuery:"",newMessage:"",selectedChat:null,leads:[],messages:[]}},computed:{filteredLeads(){return this.leads.filter(o=>o.name.toLowerCase().includes(this.searchQuery.toLowerCase()))}},methods:{async fetchLeads(){try{const s={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},p=await M.get("/api/sms/leads",{headers:s});this.leads=p.data}catch(o){console.error("Error loading leads:",o)}},async selectChat(o){try{const p={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},l=(await M.get(`/api/sms/lead/${o.leadId}`,{headers:p})).data,m=l.length>0?l[0].phone:o.phone||"";this.selectedChat={...o,phone:m},this.messages=l.reverse(),this.$nextTick(()=>this.scrollToBottom())}catch(s){console.error("Error loading messages:",s)}},async sendMessage(){const o=localStorage.getItem("auth_token"),s=parseInt(localStorage.getItem("user_id")),p={Authorization:`Bearer ${o}`};try{const k={lead_ids:[this.selectedChat.leadId],user_id:s,from:"+16187452168",to:this.selectedChat.phone,subject:"SMS Chat",message:this.newMessage};await M.post("/api/send-sms",k,{headers:p});const l=new Date,m=l.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),t=l.toISOString().slice(0,10);this.messages.push({id:`sms-sent-${Date.now()}`,type:"sms",direction:"sent",phone:this.selectedChat.phone,title:"Sent SMS",description:this.newMessage,leadId:this.selectedChat.leadId,date:t,time:m}),this.newMessage="",this.$nextTick(()=>this.scrollToBottom())}catch(k){console.error("Send SMS Error:",k),C.fire("Error","Failed to send SMS.","error")}},scrollToBottom(){const o=this.$refs.messagesArea;o&&(o.scrollTop=o.scrollHeight)}},mounted(){this.fetchLeads()}},Fe={class:"chat-container d-flex shadow rounded",style:{"block-size":"90vh","margin-block":"20px","margin-inline":"auto","max-inline-size":"1200px"}},Ve={class:"sidebar border-end d-flex flex-column bg-white",style:{"inline-size":"320px","min-inline-size":"250px"}},Ue={class:"p-3 border-bottom"},De={class:"flex-grow-1 overflow-auto chat-list"},Pe=["onClick"],Qe={class:"flex-grow-1"},Oe={class:"fw-bold"},He={class:"chat-window d-flex flex-column flex-grow-1 bg-light"},Re={key:0,class:"chat-header d-flex align-items-center p-3 border-bottom bg-white"},qe={class:"mb-0 flex-grow-1"},We={key:1,class:"chat-header d-flex align-items-center justify-content-center p-3 text-muted"},Ye={class:"messages-area flex-grow-1 p-4 overflow-auto",ref:"messagesArea"},Ke={key:0,class:"text-center small text-muted mb-2"},Ze={class:"d-block text-end mt-1 text-white-50"},Ge={key:2,class:"p-3 border-top bg-white"},Je={class:"input-group position-relative"};function Xe(o,s,p,k,l,m){return n(),d("div",Fe,[e("div",Ve,[e("div",Ue,[$(e("input",{type:"text",class:"form-control rounded-pill",placeholder:"Search lead","onUpdate:modelValue":s[0]||(s[0]=t=>l.searchQuery=t)},null,512),[[j,l.searchQuery]])]),e("div",De,[(n(!0),d(x,null,S(m.filteredLeads,t=>(n(),d("div",{key:t.leadId,onClick:b=>m.selectChat(t),class:T(["d-flex align-items-center p-3 border-bottom chat-item",{"bg-primary text-white":l.selectedChat&&l.selectedChat.leadId===t.leadId}]),style:{cursor:"pointer"}},[s[4]||(s[4]=e("img",{src:"https://cdn-icons-png.flaticon.com/512/1384/1384031.png",width:"45",height:"45",class:"rounded-circle me-3",alt:"Avatar"},null,-1)),e("div",Qe,[e("div",Oe,v(t.name),1),e("small",{class:T(["text-muted",{"text-white-50":l.selectedChat&&l.selectedChat.leadId===t.leadId}])}," Lead ID: "+v(t.leadId),3)])],10,Pe))),128))])]),e("div",He,[l.selectedChat?(n(),d("div",Re,[s[5]||(s[5]=e("img",{src:"https://cdn-icons-png.flaticon.com/512/1384/1384031.png",width:"40",height:"40",class:"rounded-circle me-3",alt:"Avatar"},null,-1)),e("h5",qe,v(l.selectedChat.name),1)])):(n(),d("div",We," Select a lead to view messages ")),e("div",Ye,[l.messages.length&&l.selectedChat?(n(!0),d(x,{key:0},S(l.messages,(t,b)=>(n(),d("div",{key:b,class:"mb-3"},[t.date?(n(),d("div",Ke,[e("strong",null,v(t.date),1)])):L("",!0),e("div",{class:T(["message-bubble p-3 rounded shadow-sm",t.direction==="sent"?"bg-success text-white ms-auto":"bg-white me-auto"]),style:{"max-inline-size":"75%"}},[e("div",null,v(t.description),1),e("small",Ze,v(t.time),1)],2)]))),128)):L("",!0)],512),l.selectedChat?(n(),d("div",Ge,[e("div",Je,[$(e("input",{type:"text",class:"form-control rounded-pill pe-5",placeholder:"Type a message","onUpdate:modelValue":s[1]||(s[1]=t=>l.newMessage=t),onKeyup:s[2]||(s[2]=oe((...t)=>m.sendMessage&&m.sendMessage(...t),["enter"]))},null,544),[[j,l.newMessage]]),e("button",{class:"btn btn-primary rounded-circle position-absolute",style:{"z-index":"1","block-size":"40px","inline-size":"40px","inset-block-start":"50%","inset-inline-end":"10px",transform:"translateY(-50%)"},onClick:s[3]||(s[3]=(...t)=>m.sendMessage&&m.sendMessage(...t))},s[6]||(s[6]=[e("i",{class:"bi bi-send"},null,-1)]))])])):L("",!0)])])}const et=D(Ne,[["render",Xe]]),tt={name:"WhatsAppComposer",data(){return{searchQuery:"",selectedChat:null,newMessage:"",showLeadModal:!1,leads:[],selectedLeadIds:[],chats:[]}},computed:{filteredChats(){return this.chats.filter(o=>(o.name||"").toLowerCase().includes(this.searchQuery.toLowerCase()))}},methods:{scrollToBottom(){this.$nextTick(()=>{const o=this.$refs.chatContainer;o&&(o.scrollTop=o.scrollHeight)})},async selectChat(o){const s=localStorage.getItem("auth_token");try{const p=await M.get(`/api/whatsapp/messages/${o.id}`,{headers:{Authorization:`Bearer ${s}`}});this.selectedChat={...o,messages:p.data},this.scrollToBottom()}catch(p){console.error("❌ Failed to load messages for chat:",p)}},async sendMessage(){if(!this.newMessage.trim()||!this.selectedChat)return;const o=localStorage.getItem("auth_token"),s=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});try{const p=await M.post("/api/whatsapp/send",{message:this.newMessage,recipients:[this.selectedChat.phone]},{headers:{Authorization:`Bearer ${o}`}});if(p.data&&p.data.status==="success"){this.selectedChat.messages||this.$set(this.selectedChat,"messages",[]),this.selectedChat.messages.push({from:"me",text:this.newMessage,time:s});const k=this.chats.find(l=>l.id===this.selectedChat.id);k&&(k.lastMessage=this.newMessage,k.time=s),this.selectedChat={...this.selectedChat},this.newMessage="",this.scrollToBottom(),this.$nextTick(()=>{const l=this.$el.querySelector(".chat-input input");l&&l.focus()})}else console.error("🚨 Message sending failed:",p.data)}catch(p){console.error("Failed to send message:",p)}},async fetchMyLeads(){try{const o=localStorage.getItem("auth_token"),s=await M.get("/api/leads",{headers:{Authorization:`Bearer ${o}`}});this.leads=s.data,this.showLeadModal=!0}catch(o){console.error("Failed to fetch leads:",o)}},useSelectedLeads(){const o=this.leads.filter(p=>this.selectedLeadIds.includes(p.id));o.forEach(p=>{if(!this.chats.find(l=>l.id===p.id)){const l={id:p.id,name:`${p.first_name||""} ${p.last_name||""}`.trim(),phone:p.phone,time:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),lastMessage:"New chat started.",messages:[]};this.chats.push(l)}});const s=o[0];s&&(this.selectedChat=this.chats.find(p=>p.id===s.id)),this.showLeadModal=!1,this.selectedLeadIds=[]},async fetchChats(){try{const o=localStorage.getItem("auth_token"),s=await M.get("/api/whatsapp/chats",{headers:{Authorization:`Bearer ${o}`}});return this.chats=s.data,Promise.resolve()}catch(o){return console.error("Failed to load chats:",o),Promise.reject(o)}}},mounted(){this.fetchChats()}},st={class:"whatsapp-ui d-flex",style:{"block-size":"90vh"}},lt={class:"chat-sidebar border-end",style:{"inline-size":"320px"}},at={class:"p-3 border-bottom d-flex justify-content-between align-items-center"},ot={class:"chat-list overflow-auto"},nt=["onClick"],it={class:"flex-grow-1"},rt={class:"d-flex justify-content-between"},dt={class:"text-muted text-truncate"},ct={key:0,class:"chat-area d-flex flex-column flex-grow-1"},ut={class:"p-3 border-bottom bg-white d-flex align-items-center"},mt={class:"flex-grow-1"},ht={class:"chat-messages flex-grow-1 overflow-auto p-3 bg-light",ref:"chatContainer"},pt={class:"text-end small mt-1"},vt={class:"chat-input p-3 bg-white border-top d-flex align-items-center"},ft={key:1,class:"chat-area d-flex flex-column flex-grow-1 justify-content-center align-items-center text-muted"},gt={class:"modal-dialog modal-lg"},bt={class:"modal-content"},yt={class:"modal-header"},wt={class:"modal-body"},_t={key:0},kt={key:1},xt=["id","value"],Ct=["for"],St={class:"modal-footer"};function Mt(o,s,p,k,l,m){return n(),d("div",st,[e("div",lt,[e("div",at,[$(e("input",{class:"form-control me-2",placeholder:"Search or start a new chat","onUpdate:modelValue":s[0]||(s[0]=t=>l.searchQuery=t)},null,512),[[j,l.searchQuery]]),e("button",{class:"btn btn-sm btn-outline-primary",onClick:s[1]||(s[1]=(...t)=>m.fetchMyLeads&&m.fetchMyLeads(...t))},"Leads")]),e("div",ot,[(n(!0),d(x,null,S(m.filteredChats,t=>(n(),d("div",{key:t.id,class:T(["chat-item d-flex p-3 border-bottom align-items-start",{"bg-light":l.selectedChat&&l.selectedChat.id===t.id}]),onClick:b=>m.selectChat(t)},[e("div",it,[e("div",rt,[e("strong",null,v(t.name),1),e("small",null,v(t.time),1)]),e("div",dt,v(t.lastMessage),1)])],10,nt))),128))])]),l.selectedChat?(n(),d("div",ct,[e("div",ut,[e("div",mt,[e("strong",null,v(l.selectedChat.name),1),s[9]||(s[9]=e("div",{class:"text-muted small"},"online",-1))]),s[10]||(s[10]=e("div",{class:"d-flex gap-2"},[e("i",{class:"bi bi-search"}),e("i",{class:"bi bi-telephone"})],-1))]),e("div",ht,[(n(!0),d(x,null,S(l.selectedChat.messages,(t,b)=>(n(),d("div",{key:b,class:"mb-3"},[e("div",{class:T(["p-2 rounded",t.from==="me"?"bg-success text-white ms-auto":"bg-white me-auto"]),style:{"max-inline-size":"75%"}},[q(v(t.text)+" ",1),e("div",pt,v(t.time),1)],2)]))),128))],512),e("div",vt,[s[12]||(s[12]=e("i",{class:"bi bi-emoji-smile me-2"},null,-1)),$(e("input",{"onUpdate:modelValue":s[2]||(s[2]=t=>l.newMessage=t),onKeyup:s[3]||(s[3]=oe((...t)=>m.sendMessage&&m.sendMessage(...t),["enter"])),class:"form-control me-2",placeholder:"Type a message"},null,544),[[j,l.newMessage]]),e("button",{class:"btn btn-primary",onClick:s[4]||(s[4]=(...t)=>m.sendMessage&&m.sendMessage(...t))},s[11]||(s[11]=[e("i",{class:"bi bi-send-fill"},null,-1)]))])])):(n(),d("div",ft,s[13]||(s[13]=[e("p",null,"Select a chat to begin",-1)]))),l.showLeadModal?(n(),d("div",{key:2,class:"modal d-block bg-dark bg-opacity-50",onClick:s[8]||(s[8]=se(t=>l.showLeadModal=!1,["self"]))},[e("div",gt,[e("div",bt,[e("div",yt,[s[14]||(s[14]=e("h5",{class:"modal-title"},"Select Leads",-1)),e("button",{type:"button",class:"btn-close",onClick:s[5]||(s[5]=t=>l.showLeadModal=!1)})]),e("div",wt,[l.leads.length===0?(n(),d("div",_t,"No leads found.")):(n(),d("div",kt,[(n(!0),d(x,null,S(l.leads,t=>(n(),d("div",{key:t.id,class:"form-check mb-2"},[$(e("input",{class:"form-check-input",type:"checkbox",id:"lead-"+t.id,"onUpdate:modelValue":s[6]||(s[6]=b=>l.selectedLeadIds=b),value:t.id},null,8,xt),[[he,l.selectedLeadIds]]),e("label",{class:"form-check-label",for:"lead-"+t.id},v(t.first_name)+" "+v(t.last_name)+" - "+v(t.phone),9,Ct)]))),128))]))]),e("div",St,[e("button",{class:"btn btn-primary",onClick:s[7]||(s[7]=(...t)=>m.useSelectedLeads&&m.useSelectedLeads(...t))},"Use Selected Leads")])])])])):L("",!0)])}const $t=D(tt,[["render",Mt],["__scopeId","data-v-8f80dfce"]]),Lt={key:0,class:"integrte_LeadModal"},Tt={class:"modal_LeadContent"},Et={class:"modal-header"},It={class:"modal_LeadBody"},At=["value","checked","onChange"],jt={key:0,class:"modal-wrapper"},Bt={class:"modal-content"},zt={class:"modal-body"},Nt={class:"mb-3"},Ft={class:"mb-3"},Vt={class:"d-flex flex-wrap align-items-center gap-2"},Ut=["onClick"],Dt={class:"mb-3"},Pt={class:"d-flex gap-2 align-items-center"},Qt=["value"],Ot={class:"mb-3"},Ht=["value"],Rt={class:"col-12"},qt={class:"mb-3"},Wt={class:"mt-2"},Yt=["onClick"],Kt={class:"mb-3"},Zt=["value"],Gt={class:"mb-4"},Jt={__name:"EmailModal",props:{show:{type:Boolean,required:!0}},emits:["close"],setup(o,{emit:s}){const p=o,k=s,l=w(!1),m=w(!1),t=w([]),b=w([]),y=w([]),_=w(null),r=w({from:"hiteshpandey732195@gmail.com",to:"",subject:"",message:"",template:"",attachments:[],schedule:""}),B=w(["{{first_name}}","{{last_name}}","{{email}}","{{city}}","{{phone}}"]),z=w([]),E=w(""),N=w([]),O=w(!1),F=localStorage.getItem("auth_token"),V=()=>{k("close"),r.value={from:"hiteshpandey732195@gmail.com",to:"",subject:"",message:"",template:"",attachments:[],schedule:""},b.value=[],y.value=[],E.value="",_.value&&_.value.setContent("")},Y=()=>{l.value=!l.value,_.value&&_.value.execCommand("mceRepaint")},K=async()=>{try{const i=await M.get("/api/leads",{headers:{Authorization:`Bearer ${F}`}});t.value=i.data.data||i.data}catch(i){console.error("Error fetching leads",i),C.fire("Error","Could not load leads.","error")}},Z=async()=>{await K(),m.value=!0},U=i=>b.value.includes(i.id),H=i=>{const a=b.value.indexOf(i.id);a===-1?b.value.push(i.id):b.value.splice(a,1)},R=()=>{m.value=!1},G=i=>{const a=y.value[i];y.value.splice(i,1);const c=t.value.find(g=>g.email===a);c&&(b.value=b.value.filter(g=>g!==c.id))};P(b,i=>{y.value=t.value.filter(a=>i.includes(a.id)).map(a=>a.email)},{deep:!0}),P(y,i=>{r.value.to=i.join(", ")},{deep:!0});const J=(i,a)=>{_.value=a,r.value.message&&a.getContent()===""&&a.setContent(r.value.message)},X={height:300,menubar:!1,plugins:"link lists image code preview fullscreen",toolbar:"undo redo | formatselect | bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent | image link code | mergefields signatures | preview fullscreen",branding:!1,resize:!0,automatic_uploads:!0,setup(i){i.ui.registry.addMenuButton("mergefields",{text:"Merge Fields",fetch(a){const c=B.value.map(g=>({type:"menuitem",text:g,onAction:()=>{i.insertContent(g)}}));a(c)}}),i.ui.registry.addMenuButton("signatures",{text:"Signatures",fetch(a){const c=z.value.map(g=>({type:"menuitem",text:g.name||`Signature ${g.id}`,onAction:()=>{i.insertContent(g.content)}}));a(c)}})}},ee=async()=>{O.value=!0;try{const i=await M.get("/api/templates",{headers:{Authorization:`Bearer ${F}`}});N.value=i.data.data??i.data}catch(i){console.error("Error fetching email templates:",i),C.fire("Error","Could not load email templates.","error")}finally{O.value=!1}},h=async()=>{if(!Array.isArray(N.value))return;const i=N.value.find(a=>a.id===r.value.template);if(i&&(r.value.subject=i.subject||"",await W(),_.value?_.value.setContent(i.content||""):r.value.message=i.content||"",i.attachment_path?r.value.attachments=[{name:i.attachment_path.split("/").pop(),path:i.attachment_path}]:r.value.attachments=[],E.value&&_.value)){const a=_.value.getContent();a.includes(E.value)||_.value.setContent(a+"<br><br>"+E.value)}},u=i=>{r.value.attachments=Array.from(i.target.files)},f=i=>{r.value.attachments.splice(i,1)},I=async()=>{try{const i=await M.get("/api/signatures",{headers:{Authorization:`Bearer ${F}`}});z.value=i.data.data}catch(i){console.error("Error fetching signatures:",i),C.fire("Error","Could not load signatures.","error")}},le=()=>{if(E.value&&_.value){const i=_.value.getContent();i.includes(E.value)||_.value.setContent(i+"<br><br>"+E.value)}},ce=i=>{const a=i.target.value;a&&(r.value.subject+=` ${a}`,i.target.value="")},ue=()=>{const i=_.value?_.value.getContent():r.value.message;C.fire({title:"Email Preview",html:`<strong>From:</strong> ${r.value.from}<br>
           <strong>To:</strong> ${r.value.to}<br>
           <strong>Subject:</strong> ${r.value.subject}<br>
           <strong>Message:</strong><br> ${i}`,icon:"info",customClass:{container:"swal-text-left"},width:"auto"})},me=async()=>{const i=parseInt(localStorage.getItem("user_id"));if(!i||isNaN(i)){C.fire({icon:"error",title:"Missing User ID",text:"Please log in again. User ID is missing or invalid."});return}const a=_.value?_.value.getContent():r.value.message;if(b.value.length===0||!r.value.subject.trim()||!a.trim()){C.fire({icon:"error",title:"Missing Information",text:"Recipient, Subject, and Message cannot be empty."});return}C.fire({title:"Are you sure?",text:"Do you want to send this email?",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, send it!",cancelButtonText:"Cancel"}).then(async c=>{if(c.isConfirmed)try{const g=new FormData;g.append("from",r.value.from),g.append("subject",r.value.subject),g.append("message",a),g.append("template_id",r.value.template||""),g.append("user_id",i),g.append("schedule",r.value.schedule||""),b.value.forEach(A=>{g.append("lead_ids[]",A)}),y.value.forEach(A=>{g.append("to[]",A)}),r.value.attachments.forEach(A=>{A instanceof File?g.append("attachments[]",A):A.path&&g.append("attachment_paths[]",A.path)}),await M.post("/api/send-email",g,{headers:{"Content-Type":"multipart/form-data",Authorization:`Bearer ${F}`}}),C.fire({icon:"success",title:"Email Sent!",text:"Your email has been successfully sent."}),V()}catch(g){console.error("Email Send Error:",g),C.fire({icon:"error",title:"Failed to Send",text:"Something went wrong. Please try again later."})}})};return P(()=>p.show,async i=>{i&&(await ee(),await I(),await W(),_.value&&_.value.setContent(""))},{immediate:!0}),(i,a)=>(n(),d(x,null,[(n(),Q(ne,{to:"body"},[m.value?(n(),d("div",Lt,[e("div",Tt,[e("div",Et,[a[8]||(a[8]=e("h2",null,"Select Leads for Email",-1)),e("button",{onClick:a[0]||(a[0]=c=>m.value=!1)},"×")]),e("div",It,[e("table",null,[a[9]||(a[9]=e("thead",null,[e("tr",null,[e("th",null,"Select"),e("th",null,"Name"),e("th",null,"Email")])],-1)),e("tbody",null,[(n(!0),d(x,null,S(t.value,c=>(n(),d("tr",{key:c.id},[e("td",null,[e("input",{type:"checkbox",value:c.id,checked:U(c),onChange:g=>H(c)},null,40,At)]),e("td",null,v(c.first_name)+" "+v(c.last_name),1),e("td",null,v(c.email),1)]))),128))])])]),e("div",{class:"modal-footer"},[e("button",{onClick:R},"Add Selected")])])])):L("",!0)])),o.show?(n(),d("div",jt,[e("div",{class:"modal-backdrop-blur",onClick:V}),o.show?(n(),d("div",{key:0,class:"modal fade show d-block",tabindex:"-1",role:"dialog",onClick:se(V,["self"])},[e("div",{class:T(["modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable",{"modal-fullscreen":l.value}])},[e("div",Bt,[e("div",{class:"modal-header"},[a[10]||(a[10]=e("h5",{class:"modal-title"},"Compose Email",-1)),e("div",{class:"d-flex align-items-center gap-2"},[e("i",{class:"fas fa-expand-alt text-primary cursor-pointer",onClick:Y,title:"Expand"}),e("button",{type:"button",class:"btn-close",onClick:V,"aria-label":"Close"})])]),e("div",zt,[e("div",Nt,[a[11]||(a[11]=e("label",{class:"form-label",for:"email-from"},"From:",-1)),$(e("input",{type:"email",id:"email-from",class:"form-control","onUpdate:modelValue":a[1]||(a[1]=c=>r.value.from=c),placeholder:"Sender email address"},null,512),[[j,r.value.from]])]),e("div",Ft,[a[12]||(a[12]=e("label",{class:"form-label"},"To:",-1)),e("div",Vt,[(n(!0),d(x,null,S(y.value,(c,g)=>(n(),d("span",{key:g,class:"badge bg-success"},[q(v(c)+" ",1),e("button",{type:"button",class:"btn-close btn-close-white btn-sm ms-2",onClick:A=>G(g)},null,8,Ut)]))),128)),e("button",{type:"button",class:"btn btn-sm btn-primary",onClick:Z}," + ")])]),e("div",Dt,[a[14]||(a[14]=e("label",{class:"form-label",for:"email-subject"},"Subject:",-1)),e("div",Pt,[$(e("input",{type:"text",id:"email-subject",class:"form-control","onUpdate:modelValue":a[2]||(a[2]=c=>r.value.subject=c),placeholder:"Email Subject"},null,512),[[j,r.value.subject]]),e("select",{class:"form-select w-auto",onChange:a[3]||(a[3]=c=>ce(c))},[a[13]||(a[13]=e("option",{value:""},"+ Merge Field",-1)),(n(!0),d(x,null,S(B.value,c=>(n(),d("option",{key:c,value:c},v(c),9,Qt))),128))],32)])]),e("div",Ot,[a[16]||(a[16]=e("label",{class:"form-label"},"Template:",-1)),$(e("select",{class:"form-select","onUpdate:modelValue":a[4]||(a[4]=c=>r.value.template=c),onChange:h},[a[15]||(a[15]=e("option",{value:"",disabled:""},"Select a Template",-1)),(n(!0),d(x,null,S(N.value,c=>(n(),d("option",{key:c.id,value:c.id},v(c.name),9,Ht))),128))],544),[[te,r.value.template]])]),e("div",Rt,[a[17]||(a[17]=e("label",{class:"form-label"},"* Body",-1)),ie(re(de),{init:X,modelValue:r.value.message,"onUpdate:modelValue":a[5]||(a[5]=c=>r.value.message=c),onInit:J},null,8,["modelValue"])]),e("div",qt,[a[18]||(a[18]=e("label",{class:"form-label"},"Attachments:",-1)),e("input",{type:"file",class:"form-control",multiple:"",onChange:u},null,32),e("div",Wt,[(n(!0),d(x,null,S(r.value.attachments,(c,g)=>(n(),d("span",{key:g,class:"badge bg-secondary me-2"},[q(v(c.name||c.path||c)+" ",1),e("button",{type:"button",class:"btn-close btn-close-white btn-sm ms-2",onClick:A=>f(g)},null,8,Yt)]))),128))])]),e("div",Kt,[a[20]||(a[20]=e("label",{class:"form-label"},"Signature:",-1)),$(e("select",{class:"form-select","onUpdate:modelValue":a[6]||(a[6]=c=>E.value=c),onChange:le},[a[19]||(a[19]=e("option",{value:""},"No Signature",-1)),(n(!0),d(x,null,S(z.value,c=>(n(),d("option",{key:c.id,value:c.content},v(c.name||"Signature "+c.id),9,Zt))),128))],544),[[te,E.value]])]),e("div",Gt,[a[21]||(a[21]=e("label",{class:"form-label"},"Schedule Email:",-1)),$(e("input",{type:"datetime-local",class:"form-control","onUpdate:modelValue":a[7]||(a[7]=c=>r.value.schedule=c)},null,512),[[j,r.value.schedule]])]),e("div",{class:"d-flex justify-content-end gap-2"},[e("button",{class:"btn btn-info",onClick:ue},"Preview"),e("button",{class:"btn btn-success",onClick:me},"Send Email")])])])],2)])):L("",!0)])):L("",!0)],64))}},Xt=D(Jt,[["__scopeId","data-v-3717dfd6"]]),es={key:0,class:"integrte_LeadModal"},ts={class:"modal_LeadContent"},ss={class:"modal-header"},ls={class:"modal_LeadBody"},as=["value","checked","onChange"],os={key:0,class:"modal-wrapper"},ns={class:"modal-content"},is={class:"modal-header"},rs={class:"d-flex align-items-center gap-2"},ds={class:"modal-body"},cs={class:"mb-3"},us={class:"mb-3"},ms={class:"d-flex flex-wrap align-items-center gap-2"},hs=["onClick"],ps={class:"mb-3"},vs=["value"],fs={class:"mb-3"},gs={class:"mb-4"},bs={__name:"SmsModal",props:{show:{type:Boolean,required:!0}},emits:["close"],setup(o,{emit:s}){const p=o,k=s,l=w(!1),m=w(!1),t=w([]),b=w([]),y=w([]);w(null);const _=w(["{{first_name}}","{{last_name}}","{{email}}","{{city}}","{{phone}}"]),r=w({from:"",to:"",toName:"",subject:"",message:"",template:"",schedule:""});P(()=>p.show,h=>{h?W(()=>{R()}):(r.value={from:"",to:"",toName:"",subject:"",message:"",template:"",schedule:""},t.value=[],y.value=[])});const B=()=>{k("close")},z=()=>{r.value.to=t.value.map(h=>h.phone).join(", "),r.value.toName=t.value.map(h=>h.first_name).join(", ")},E=h=>{const u=y.value.indexOf(h.id);u===-1?(y.value.push(h.id),t.value.push({id:h.id,first_name:h.first_name,phone:h.phone})):(y.value.splice(u,1),t.value=t.value.filter(f=>f.id!==h.id)),z()},N={height:300,menubar:!1,plugins:"link lists code",toolbar:"undo redo | bold italic underline | alignleft aligncenter alignright | bullist numlist | mergeFieldButton",branding:!1,setup(h){h.ui.registry.addMenuButton("mergeFieldButton",{text:"Merge Fields",fetch(u){const f=_.value.map(I=>({type:"menuitem",text:I,onAction:()=>{h.insertContent(I)}}));u(f)}})}},O=h=>y.value.includes(h.id),F=localStorage.getItem("auth_token"),V=async()=>{try{const h=await M.get("/api/leads",{headers:{Authorization:`Bearer ${F}`}});b.value=h.data}catch(h){console.error("Error fetching leads",h)}},Y=async()=>{await V(),m.value=!0},K=h=>{const u=t.value[h];t.value.splice(h,1),y.value=y.value.filter(f=>f!==u.id),z()};P(y,()=>{r.value.to=t.value.map(h=>h.phone).join(", "),r.value.toName=t.value.map(h=>h.first_name).join(", ")});const Z=()=>{m.value=!1},U=w([]),H=w(!1),R=async()=>{H.value=!0;try{const h=await M.get("/api/sms-templates");U.value=h.data.templates}catch{C.fire("Error","Could not load SMS templates.","error")}finally{H.value=!1}},G=()=>{if(!Array.isArray(U.value))return;const h=U.value.find(u=>u.id===r.value.template);h&&(r.value.message=h.content)},J=()=>{C.fire({title:"SMS Preview",html:`<strong>From:</strong> ${r.value.from}<br>
              <strong>To:</strong> ${r.value.to}<br>
              <strong>Message:</strong><br> ${r.value.message}`,icon:"info"})},X=async()=>{const h=parseInt(localStorage.getItem("user_id"));if(!h||isNaN(h)){C.fire("Missing User ID","Please log in again.","error");return}if(t.value.length===0||!r.value.message.trim()){C.fire("Missing Information","Recipient and message cannot be empty.","error");return}try{const u=t.value.map(I=>I.phone),f=t.value.map(I=>I.id);await M.post("/api/send-sms",{lead_ids:f,user_id:h,from:r.value.from,to:u.join(", "),message:r.value.message,schedule:r.value.schedule||null}),C.fire("Success","SMS sent successfully.","success"),B()}catch(u){console.error("SMS Send Error:",u),C.fire("Error","Failed to send SMS.","error")}},ee=()=>{l.value=!l.value,W(()=>{})};return pe(()=>{R()}),(h,u)=>(n(),d(x,null,[(n(),Q(ne,{to:"body"},[m.value?(n(),d("div",es,[e("div",ts,[e("div",ss,[u[6]||(u[6]=e("h2",null,"Select Leads",-1)),e("button",{onClick:u[0]||(u[0]=f=>m.value=!1)},"×")]),e("div",ls,[e("table",null,[u[7]||(u[7]=e("thead",null,[e("tr",null,[e("th",null,"Select"),e("th",null,"Name"),e("th",null,"Phone")])],-1)),e("tbody",null,[(n(!0),d(x,null,S(b.value,f=>(n(),d("tr",{key:f.id},[e("td",null,[e("input",{type:"checkbox",value:f.phone,checked:O(f),onChange:I=>E(f)},null,40,as)]),e("td",null,v(f.first_name)+" "+v(f.last_name),1),e("td",null,v(f.phone),1)]))),128))])])]),e("div",{class:"modal-footer"},[e("button",{onClick:Z},"Add Selected")])])])):L("",!0)])),o.show?(n(),d("div",os,[e("div",{class:"modal-backdrop-blur",onClick:B}),o.show?(n(),d("div",{key:0,class:"modal fade show d-block",tabindex:"-1",role:"dialog",onClick:se(B,["self"])},[e("div",{class:T(["modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable",{"modal-fullscreen":l.value}])},[e("div",ns,[e("div",is,[u[8]||(u[8]=e("h5",{class:"modal-title"},"Compose SMS",-1)),e("div",rs,[e("i",{class:"fas fa-expand-alt text-primary cursor-pointer",onClick:ee,title:"Expand"}),e("button",{type:"button",class:"btn-close",onClick:u[1]||(u[1]=f=>h.$emit("close")),"aria-label":"Close"})])]),e("div",ds,[e("div",cs,[u[9]||(u[9]=e("label",{class:"form-label",for:"sms-from"},"From:",-1)),$(e("input",{type:"text",id:"sms-from",class:"form-control","onUpdate:modelValue":u[2]||(u[2]=f=>r.value.from=f),placeholder:"Sender name or phone"},null,512),[[j,r.value.from]])]),e("div",us,[u[10]||(u[10]=e("label",{class:"form-label"},"To:",-1)),e("div",ms,[(n(!0),d(x,null,S(t.value,(f,I)=>(n(),d("span",{key:f.id,class:"badge bg-success"},[q(v(f.first_name)+" ",1),e("button",{type:"button",class:"btn-close btn-close-white btn-sm ms-2",onClick:le=>K(I)},null,8,hs)]))),128)),e("button",{type:"button",class:"btn btn-sm btn-primary",onClick:Y}," + ")])]),e("div",ps,[u[12]||(u[12]=e("label",{class:"form-label"},"Template:",-1)),$(e("select",{class:"form-select","onUpdate:modelValue":u[3]||(u[3]=f=>r.value.template=f),onChange:G},[u[11]||(u[11]=e("option",{value:"",disabled:""},"Select a Template",-1)),(n(!0),d(x,null,S(U.value,f=>(n(),d("option",{key:f.id,value:f.id},v(f.name),9,vs))),128))],544),[[te,r.value.template]])]),e("div",fs,[u[13]||(u[13]=e("label",{class:"form-label"},"Message:",-1)),ie(re(de),{id:"sms-editor",init:N,modelValue:r.value.message,"onUpdate:modelValue":u[4]||(u[4]=f=>r.value.message=f)},null,8,["modelValue"])]),e("div",gs,[u[14]||(u[14]=e("label",{class:"form-label"},"Schedule SMS:",-1)),$(e("input",{type:"datetime-local",class:"form-control","onUpdate:modelValue":u[5]||(u[5]=f=>r.value.schedule=f)},null,512),[[j,r.value.schedule]])]),e("div",{class:"d-flex justify-content-end gap-2"},[e("button",{class:"btn btn-info",onClick:J}," Preview "),e("button",{class:"btn btn-success",onClick:X}," Send SMS ")])])])],2)])):L("",!0)])):L("",!0)],64))}},ys=D(bs,[["__scopeId","data-v-99df4e1a"]]),ws={name:"Inbox",components:{SMS:et,Email:ze,WhatsApp:$t,SmsModal:ys,EmailModal:Xt},data(){return{activeTab:localStorage.getItem("activeTab")||"sms",showSmsModal:!1,showEmailModal:!1}},computed:{activeTabComponent(){return this.activeTab==="email"?"Email":this.activeTab==="sms"?"SMS":this.activeTab==="whatsapp"?"WhatsApp":"SMS"}},methods:{setActiveTab(o){this.activeTab=o,localStorage.setItem("activeTab",o)},openSmsModal(){console.log("[OPEN SMS MODAL] Triggered"),this.showSmsModal=!0},openEmailModal(){console.log("[OPEN EMAIL MODAL] Triggered"),this.showEmailModal=!0},closeSmsModal(){this.showSmsModal=!1},closeEmailModal(){this.showEmailModal=!1}}},_s={class:"container py-3"},ks={class:"d-flex justify-content-between align-items-center mb-3"},xs={class:"btn-group me-3"};function Cs(o,s,p,k,l,m){const t=ae("SmsModal"),b=ae("EmailModal");return n(),d("div",_s,[e("div",ks,[e("div",xs,[e("button",{onClick:s[0]||(s[0]=y=>m.setActiveTab("email")),class:T(["btn",l.activeTab==="email"?"btn-primary text-white":"btn-outline-primary"])}," Email ",2),e("button",{onClick:s[1]||(s[1]=y=>m.setActiveTab("sms")),class:T(["btn",l.activeTab==="sms"?"btn-primary text-white":"btn-outline-primary"])}," SMS ",2),e("button",{onClick:s[2]||(s[2]=y=>m.setActiveTab("whatsapp")),class:T(["btn",l.activeTab==="whatsapp"?"btn-success text-white":"btn-outline-success"])}," WhatsApp ",2)]),s[7]||(s[7]=e("div",{class:"me-auto"},[e("select",{class:"form-select",style:{"inline-size":"150px"}},[e("option",null,"Inbox"),e("option",null,"Sent")])],-1)),e("div",null,[e("button",{class:"btn btn-primary me-2 btn big-dark-button",onClick:s[3]||(s[3]=(...y)=>m.openEmailModal&&m.openEmailModal(...y))}," + Send New Email "),e("button",{class:"btn big-dark-button",onClick:s[4]||(s[4]=(...y)=>m.openSmsModal&&m.openSmsModal(...y))}," + Send New SMS ")])]),(n(),Q(ve(m.activeTabComponent))),l.showSmsModal?(n(),Q(t,{key:0,show:l.showSmsModal,onClose:s[5]||(s[5]=y=>l.showSmsModal=!1)},null,8,["show"])):L("",!0),l.showEmailModal?(n(),Q(b,{key:1,show:l.showEmailModal,onClose:s[6]||(s[6]=y=>l.showEmailModal=!1)},null,8,["show"])):L("",!0)])}const Is=D(ws,[["render",Cs]]);export{Is as default};
